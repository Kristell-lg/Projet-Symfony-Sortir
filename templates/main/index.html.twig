{% extends 'base.html.twig' %}

{% block title %} {{ parent() }} | Accueil {% endblock %}

{% block body %}
    <main>
        <div class="generalBig">
            <h1>Accueil</h1>


            <div class="sorties">

                <table>

                    <thead>
                        <tr>
                            <th><p>Nom de la sortie</p></th>
                            <th><p>Date de la sortie</p></th>
                            <th><p>Date de Clôture</p></th>
                            <th><p>Inscription/Places</p></th>
                            <th><p>Etat</p></th>
                            <th><p>Inscrit</p></th>
                            <th><p>Organisateur</p></th>
                            <th><p>Actions</p></th>

                        </tr>
                    </thead>

                    <tbody>
                    {% for s in sortie  %}

                        {# Cherche si la personne connectée est dans les participants #}
                        {% set participe = 0 %}

                        {% for p in s.sortieParticipants %}
                            {% if p.id == app.user.id %}
                                {%  set participe = 1 %}
                            {% endif %}
                        {% endfor %}

                        {# N'affiche que si c'est publié ou si l'on en est le owner #}
                        {% if s.etats.id != '1' or s.organisateur.id == app.user.id %}
                        <tr>
                            <td><p>{{ s.nom }} </p></td>
                            <td><p>{{ s.dateHeureDebut | date('d/m/Y')}}</p></td>
                            <td><p>{{ s.dateLimiteInscription | date('d/m/Y')}}</p></td>
                            <td><p> {{ s.sortieParticipants |length }} / {{ s.nbInscriptionMax  }}</p></td>
                            <td><p>{{ s.etats.libelle }}</p></td>
                            <td>
                                {% if participe %}
                                    <p>X</p>
                                {% endif %}
                            </td>
                            <td><p>{{ s.organisateur.nom |upper }} {{ s.organisateur.prenom}}</p></td>
                            <td><p>

                                    <a href="{{ path('sortie_details', {'id':s.id}) }}">Afficher</a>

                                    {% if s.etats.id == '1' and s.organisateur.id == app.user.id %}
                                    <a href="{{ path('sortie_update', {'id':s.id}) }}">Modifier</a>
                                    {% endif %}

                                    {% if s.etats.id == '2' and s.organisateur.id == app.user.id %}
                                        <a href="{{ path('sortie_cancel', {'id':s.id}) }}">Annuler</a>
                                    {% endif %}

                                    {% if s.etats.id == '2' and s.organisateur.id != app.user.id and participe == 0
                                        and s.dateLimiteInscription | date('d/m/Y') < "now" | date('d/m/Y')
                                        and s.nbInscriptionMax > s.sortieParticipants | length %}
                                    <a href="{{ path('sortie_register', {'idSortie':s.id, 'idUser':app.user.id }) }}">S'inscrire</a>
                                    {% endif %}

                                    {% if s.etats.id == '2' and s.organisateur.id != app.user.id and participe == 1  %}
                                    <a href="{{ path('sortie_unsubscribe', {'idSortie':s.id, 'idUser':app.user.id }) }}">Se désinscrire</a>
                                    {% endif %}

                            </p></td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                    </tbody>

                </table>
            </div>

            {% if is_granted("ROLE_ADMIN") %}
                <div class="creation_sortie">
                    <button><a href="{{ path('sortie_create') }}"> Créer une sortie</a></button>
                </div>
            {% endif %}

        </div>
    </main>
{% endblock %}

